---
# Available tags: web_app_wipe, app_deploy, compose

# Wipe runs FIRST - enables clean reinstall when -e "web_app_wipe=true" is passed
- name: Include wipe tasks
  ansible.builtin.include_tasks: wipe.yml
  tags:
    - web_app_wipe

- name: Deploy application with Docker Compose
  block:

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ compose_project_dir }}"
        state: directory
        owner: "{{ docker_user | default('vagrant') }}"
        group: "{{ docker_user | default('vagrant') }}"
        mode: "0755"

    - name: Template docker-compose.yml to target host
      ansible.builtin.template:
        src: docker-compose.yml.j2
        dest: "{{ compose_project_dir }}/docker-compose.yml"
        owner: "{{ docker_user | default('vagrant') }}"
        group: "{{ docker_user | default('vagrant') }}"
        mode: "0640"

    - name: Pull Docker image
      ansible.builtin.command: "docker pull {{ docker_image }}:{{ docker_tag }}"
      register: pull_result
      changed_when: "'Pull complete' in pull_result.stdout or 'Downloaded' in pull_result.stdout"

    - name: Deploy with Docker Compose
      ansible.builtin.command: >
        docker compose -f {{ compose_project_dir }}/docker-compose.yml up --detach --remove-orphans
      register: compose_up_result
      changed_when: "'Started' in compose_up_result.stderr or 'Recreated' in compose_up_result.stderr"

    - name: Wait for application to be healthy
      ansible.builtin.uri:
        url: "http://localhost:{{ app_port }}/health"
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 10
      delay: 5

    - name: Report deployment success
      ansible.builtin.debug:
        msg: "{{ app_name }} is running at http://localhost:{{ app_port }}"

  rescue:
    - name: "[RESCUE] Show container logs"
      ansible.builtin.command: >
        docker compose -f {{ compose_project_dir }}/docker-compose.yml logs --tail=30
      register: compose_logs
      changed_when: false
      ignore_errors: true

    - name: "[RESCUE] Print logs"
      ansible.builtin.debug:
        msg: "{{ compose_logs.stdout_lines | default([]) }}"

    - name: "[RESCUE] Fail with clear message"
      ansible.builtin.fail:
        msg: "Deployment of {{ app_name }} failed - check logs above"

  always:
    - name: "[ALWAYS] Show running containers"
      ansible.builtin.command: docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}\t{{.Ports}}{% endraw %}"
      register: docker_ps
      changed_when: false
      failed_when: false

    - name: "[ALWAYS] Report container status"
      ansible.builtin.debug:
        msg: "{{ docker_ps.stdout_lines }}"

  become: true
  tags:
    - app_deploy
    - compose
