---
# Available tags: docker, docker_install, docker_config

- name: Docker installation block
  block:

    - name: Create /etc/apt/keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: "{{ docker_apt_key_url }}"
        dest: "{{ docker_apt_key_path }}"
        mode: "0644"
        force: false

    - name: Add Docker APT repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by={{ docker_apt_key_path }}] {{ docker_apt_repo }} {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
        update_cache: true

    - name: Install Docker packages
      ansible.builtin.apt:
        name: "{{ docker_packages }}"
        state: present

  rescue:
    - name: "[RESCUE] Wait 10 seconds before retrying"
      ansible.builtin.pause:
        seconds: 10

    - name: "[RESCUE] Force re-download Docker GPG key"
      ansible.builtin.get_url:
        url: "{{ docker_apt_key_url }}"
        dest: "{{ docker_apt_key_path }}"
        mode: "0644"
        force: true

    - name: "[RESCUE] Retry Docker package install"
      ansible.builtin.apt:
        name: "{{ docker_packages }}"
        state: present
        update_cache: true

  always:
    - name: "[ALWAYS] Ensure Docker service is enabled and started"
      ansible.builtin.service:
        name: docker
        enabled: true
        state: started
      ignore_errors: true

  become: true
  tags:
    - docker
    - docker_install

- name: Docker configuration block
  block:

    - name: Ensure /etc/docker directory exists
      ansible.builtin.file:
        path: /etc/docker
        state: directory
        mode: "0755"

    - name: Write Docker daemon.json
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        content: "{{ docker_daemon_config | to_nice_json }}\n"
        mode: "0644"
      notify: Restart Docker

    - name: Add {{ docker_user }} to docker group
      ansible.builtin.user:
        name: "{{ docker_user }}"
        groups: docker
        append: true

    - name: Install Python Docker SDK
      ansible.builtin.pip:
        name:
          - docker
          - docker-compose
        state: present
        executable: pip3

  rescue:
    - name: "[RESCUE] Log Docker configuration failure"
      ansible.builtin.debug:
        msg: "Docker configuration failed - check Docker installation"

  always:
    - name: "[ALWAYS] Verify Docker is responding"
      ansible.builtin.command: docker info
      register: docker_info
      changed_when: false
      failed_when: false

    - name: "[ALWAYS] Report Docker status"
      ansible.builtin.debug:
        msg: "Docker running: {{ docker_info.rc == 0 }}"

  become: true
  tags:
    - docker
    - docker_config
